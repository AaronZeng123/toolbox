<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mermaid æµç¨‹å›¾é¢„è§ˆå·¥å…·</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
            background: white;
            margin: 20px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .main-content {
            display: flex;
            width: 100%;
            margin-top: 70px;
        }

        .editor-panel {
            width: 50%;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #e0e0e0;
        }

        .panel-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
            font-weight: 600;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .editor-container {
            flex: 1;
            position: relative;
        }

        .CodeMirror {
            height: 100% !important;
            font-size: 14px;
            line-height: 1.5;
        }

        .preview-panel {
            width: 50%;
            display: flex;
            flex-direction: column;
        }

        .preview-container {
            flex: 1;
            padding: 20px;
            overflow: hidden;
            background: #fafafa;
            position: relative;
        }

        .zoom-controls {
            position: absolute;
            top: 30px;
            right: 30px;
            z-index: 100;
            display: flex;
            gap: 5px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .zoom-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 4px;
            background: #667eea;
            color: white;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .zoom-btn:hover {
            background: #5a67d8;
            transform: scale(1.1);
        }

        .zoom-level {
            display: flex;
            align-items: center;
            padding: 0 8px;
            font-size: 12px;
            color: #666;
            font-weight: 500;
            min-width: 40px;
            justify-content: center;
        }

        .diagram-viewport {
            width: 100%;
            height: 100%;
            overflow: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: grab;
        }

        .diagram-viewport:active {
            cursor: grabbing;
        }

        .diagram-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
            transform-origin: center center;
            min-width: fit-content;
            min-height: fit-content;
        }

        /* å…¨å±æ¨¡å¼æ ·å¼ */
        .fullscreen-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .fullscreen-overlay.active {
            display: flex;
        }

        .fullscreen-content {
            position: relative;
            width: 90%;
            height: 90%;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .fullscreen-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 10001;
        }

        .fullscreen-title {
            color: white;
            font-weight: 600;
            font-size: 16px;
        }

        .fullscreen-controls {
            display: flex;
            gap: 10px;
        }

        .fullscreen-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s ease;
        }

        .fullscreen-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .fullscreen-viewport {
            position: absolute;
            top: 50px;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: auto;
            cursor: grab;
            background: #f8f9fa;
        }

        .fullscreen-viewport:active {
            cursor: grabbing;
        }

        .fullscreen-diagram {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100%;
            padding: 20px;
        }

        #mermaid-output {
            width: 100%;
            height: 100%;
        }

        .error-message {
            color: #e74c3c;
            background: #fdf2f2;
            border: 1px solid #fecaca;
            border-radius: 6px;
            padding: 15px;
            margin: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .examples {
            position: absolute;
            top: 15px;
            right: 20px;
        }

        .example-select {
            padding: 6px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            font-size: 12px;
            cursor: pointer;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #666;
            font-size: 16px;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                flex-direction: column;
            }
            
            .main-content {
                flex-direction: column;
            }
            
            .editor-panel, .preview-panel {
                width: 100%;
                height: 50%;
            }
            
            .header h1 {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¨ Mermaid æµç¨‹å›¾é¢„è§ˆå·¥å…·</h1>
        <div class="header-buttons">
            <button class="btn" onclick="exportSVG()">å¯¼å‡º SVG</button>
            <button class="btn" onclick="exportPNG()">å¯¼å‡º PNG</button>
            <button class="btn" onclick="clearEditor()">æ¸…ç©º</button>
        </div>
    </div>

    <div class="container">
        <div class="main-content">
            <div class="editor-panel">
                <div class="panel-header">
                    ğŸ“ Mermaid ä»£ç ç¼–è¾‘å™¨
                    <div class="examples">
                        <select class="example-select" onchange="loadExample(this.value)">
                            <option value="">é€‰æ‹©ç¤ºä¾‹...</option>
                            <option value="flowchart">æµç¨‹å›¾</option>
                            <option value="sequence">æ—¶åºå›¾</option>
                            <option value="gantt">ç”˜ç‰¹å›¾</option>
                            <option value="class">ç±»å›¾</option>
                            <option value="state">çŠ¶æ€å›¾</option>
                            <option value="pie">é¥¼å›¾</option>
                        </select>
                    </div>
                </div>
                <div class="editor-container">
                    <textarea id="mermaid-code">graph TD
    A[å¼€å§‹] --> B{æ˜¯å¦æ»¡è¶³æ¡ä»¶?}
    B -->|æ˜¯| C[æ‰§è¡Œæ“ä½œ]
    B -->|å¦| D[è·³è¿‡æ“ä½œ]
    C --> E[ç»“æŸ]
    D --> E
    
    style A fill:#e1f5fe
    style E fill:#c8e6c9
    style B fill:#fff3e0</textarea>
                </div>
            </div>

            <div class="preview-panel">
                <div class="panel-header">
                    ğŸ–¼ï¸ å›¾è¡¨é¢„è§ˆ
                </div>
                <div class="preview-container">
                    <div class="zoom-controls">
                    <button class="zoom-btn" id="zoom-out" title="ç¼©å°">âˆ’</button>
                    <span class="zoom-level" id="zoom-level">100%</span>
                    <button class="zoom-btn" id="zoom-in" title="æ”¾å¤§">+</button>
                    <button class="zoom-btn" id="zoom-reset" title="é‡ç½®">âŒ‚</button>
                    <button class="zoom-btn" id="zoom-fit" title="é€‚åº”å±å¹•">âŠ¡</button>
                    <button class="zoom-btn" id="fullscreen-btn" title="å…¨å±æ˜¾ç¤º">â›¶</button>
                </div>
                    <div class="diagram-viewport" id="diagram-viewport">
                        <div class="diagram-container" id="diagram-container">
                            <div id="mermaid-output"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å…¨å±è¦†ç›–å±‚ -->
    <div class="fullscreen-overlay" id="fullscreen-overlay">
        <div class="fullscreen-content">
            <div class="fullscreen-header">
                <div class="fullscreen-title">Mermaid æµç¨‹å›¾ - å…¨å±é¢„è§ˆ</div>
                <div class="fullscreen-controls">
                    <button class="fullscreen-btn" id="fullscreen-zoom-out" title="ç¼©å°">âˆ’</button>
                    <span class="fullscreen-btn" id="fullscreen-zoom-level">100%</span>
                    <button class="fullscreen-btn" id="fullscreen-zoom-in" title="æ”¾å¤§">+</button>
                    <button class="fullscreen-btn" id="fullscreen-zoom-reset" title="é‡ç½®">âŒ‚</button>
                    <button class="fullscreen-btn" id="fullscreen-zoom-fit" title="é€‚åº”å±å¹•">âŠ¡</button>
                    <button class="fullscreen-btn" id="fullscreen-close" title="é€€å‡ºå…¨å±">âœ•</button>
                </div>
            </div>
            <div class="fullscreen-viewport" id="fullscreen-viewport">
                <div class="fullscreen-diagram" id="fullscreen-diagram">
                    <!-- å…¨å±å›¾è¡¨å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„åº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@11.12.2/dist/mermaid.min.js"></script>
    <!-- å¼•å…¥ canvg ç”¨äºè§£å†³ PNG å¯¼å‡ºæ—¶çš„è·¨åŸŸå’Œæ¸²æŸ“é—®é¢˜ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/canvg/1.5.3/canvg.min.js"></script>

    <script>
        // åˆå§‹åŒ– Mermaid
        mermaid.initialize({
            startOnLoad: false,
            theme: 'default',
            securityLevel: 'loose',
            fontFamily: 'Segoe UI, Tahoma, Geneva, Verdana, sans-serif'
        });

        // åˆå§‹åŒ– CodeMirror ç¼–è¾‘å™¨
        const editor = CodeMirror.fromTextArea(document.getElementById('mermaid-code'), {
            lineNumbers: true,
            mode: 'javascript',
            theme: 'monokai',
            lineWrapping: true,
            autoCloseBrackets: true,
            matchBrackets: true,
            indentUnit: 2,
            tabSize: 2
        });

        let renderTimeout;
        let currentZoom = 1;
        let isDragging = false;
        let dragStart = { x: 0, y: 0 };
        let scrollStart = { x: 0, y: 0 };
        let isFullscreen = false;
        let fullscreenZoom = 1;

        // è‡ªåŠ¨ä¿®å¤ä»£ç ä¸­çš„å¸¸è§é—®é¢˜ï¼ˆå¦‚ä¸­æ–‡æ ‡ç‚¹ã€åˆ†éš”çº¿ç­‰ï¼‰
        function autoFixMermaidCode(code) {
            // 1. å…¨å±€å­—ç¬¦æ›¿æ¢ï¼ˆä¸­æ–‡æ ‡ç‚¹ -> è‹±æ–‡æ ‡ç‚¹ï¼‰
            let newCode = code;
            const replacements = {
                'ï¼š': ':',
                'ï¼›': ';',
                'ï¼ˆ': '(',
                'ï¼‰': ')',
                'ï¼Œ': ',',
                'â€œ': '"',
                'â€': '"',
                'â€˜': "'",
                'â€™': "'",
                'ã€': '[',
                'ã€‘': ']'
            };
            
            for (const [cn, en] of Object.entries(replacements)) {
                newCode = newCode.split(cn).join(en);
            }

            // 2. è¡Œçº§å¤„ç†
            const lines = newCode.split('\n');
            const fixedLines = lines.map(line => {
                let text = line.trim();
                if (!text) return line;

                // 2.1 å¤„ç† Markdown é£æ ¼æ ‡é¢˜ (# Title) -> è½¬ä¸ºæ³¨é‡Š
                // Mermaid æŸäº›å›¾è¡¨ç±»å‹ä¸æ”¯æŒ # æ³¨é‡Š
                if (text.startsWith('# ')) {
                    return '%% ' + line.trim();
                }

                // 2.2 å¤„ç†åˆ†éš”çº¿/è£…é¥°çº¿
                // åŒ¹é…çº¯åˆ†éš”ç¬¦ (å¦‚ ----------------, =======)
                // æˆ–è€…ä»¥é•¿åˆ†éš”ç¬¦ç»“å°¾çš„æ–‡æœ¬ (å¦‚ "Header ----------------")
                // æ³¨æ„ï¼šè¦é¿å…è¯¯ä¼¤ Mermaid çš„ç®­å¤´ (-->) æˆ– è¿çº¿ (---)
                // åˆæ³•çš„è¿çº¿é€šå¸¸è¿æ¥ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œæˆ–è€…åœ¨ä¸­é—´ã€‚
                // å¦‚æœè¡Œå°¾å‡ºç°é•¿ä¸² - æˆ– = (è¶…è¿‡4ä¸ª)ï¼Œé€šå¸¸æ˜¯æ–‡æœ¬åˆ†éš”ç¬¦æˆ–æœªå®Œæˆçš„è¯­å¥
                
                // æ£€æŸ¥è¡Œå°¾æ˜¯å¦æœ‰é•¿åˆ†éš”ç¬¦ (5ä¸ªä»¥ä¸Š)
                if (/[-=_*]{5,}$/.test(text)) {
                    // å†æ¬¡ç¡®è®¤å®ƒä¸æ˜¯ä¸€ä¸ªåˆæ³•çš„æŒ‡å‘ï¼ˆä¾‹å¦‚ A -----> Bï¼Œä»¥Bç»“å°¾ï¼Œä¸ä¼šåŒ¹é… $ï¼‰
                    // å¦‚æœæ˜¯ A ----->ï¼Œå®ƒä»¥ > ç»“å°¾ï¼Œä¹Ÿä¸ä¼šåŒ¹é… [-=_*]
                    // æ‰€ä»¥è¿™é‡Œä¸»è¦åŒ¹é… "Title -----" æˆ– "-------"
                    return '%% ' + line.trim();
                }
                
                // æ£€æŸ¥æ˜¯å¦æ•´è¡Œéƒ½æ˜¯ç‰¹æ®Šå­—ç¬¦ï¼ˆå¯èƒ½æ˜¯åˆ†éš”çº¿ï¼‰
                if (/^[-=_*]{3,}$/.test(text)) {
                    return '%% ' + line.trim();
                }

                return line;
            });
            
            return fixedLines.join('\n');
        }

        // æ¸²æŸ“ Mermaid å›¾è¡¨
        async function renderMermaid() {
            const code = editor.getValue().trim();
            const outputDiv = document.getElementById('mermaid-output');
            
            if (!code) {
                outputDiv.innerHTML = '<div class="loading">è¯·è¾“å…¥ Mermaid ä»£ç ...</div>';
                return;
            }

            try {
                outputDiv.innerHTML = '<div class="loading"><div class="spinner"></div>æ­£åœ¨æ¸²æŸ“å›¾è¡¨...</div>';
                
                // æ¸…é™¤ä¹‹å‰çš„å›¾è¡¨
                // outputDiv.innerHTML = ''; // ä¸è¦è¿‡æ—©æ¸…é™¤ï¼Œä»¥å…é—ªçƒ
                
                // ä½¿ç”¨ mermaid.render æ–¹æ³•
                // Mermaid v10+ è¿”å› { svg } å¯¹è±¡
                const { svg } = await mermaid.render('mermaid-graph-' + Date.now(), code);
                outputDiv.innerHTML = svg;
                
                // é‡ç½®ç¼©æ”¾
                // åªæœ‰å½“å›¾è¡¨å†…å®¹å‘ç”Ÿé‡å¤§å˜åŒ–æ—¶æ‰é‡ç½®ç¼©æ”¾å¯èƒ½ä¼šæ›´å¥½ï¼Œä½†ä¸ºäº†ç®€å•èµ·è§ï¼Œè¿™é‡Œä¿æŒåŸæ ·
                // å¦‚æœç”¨æˆ·æ­£åœ¨ç¼©æ”¾æŸ¥çœ‹ç»†èŠ‚ï¼Œæ¯æ¬¡è¾“å…¥éƒ½é‡ç½®ä¼šå¾ˆçƒ¦äºº
                // æˆ‘ä»¬å¯ä»¥æ£€æŸ¥ä¸€ä¸‹æ˜¯å¦æ˜¯ç¬¬ä¸€æ¬¡æ¸²æŸ“
                if (currentZoom === 1 && scrollStart.x === 0 && scrollStart.y === 0) {
                     resetZoom();
                } else {
                     applyZoom();
                }
                
            } catch (error) {
                console.error('Mermaid rendering error:', error);
                
                // å°è¯•è‡ªåŠ¨ä¿®å¤
                const fixedCode = autoFixMermaidCode(code);
                if (fixedCode !== code) {
                    try {
                        // å°è¯•éªŒè¯ä¿®å¤åçš„ä»£ç æ˜¯å¦æœ‰æ•ˆ
                        await mermaid.parse(fixedCode);
                        
                        // å¦‚æœè§£ææˆåŠŸï¼Œæ›´æ–°ç¼–è¾‘å™¨å†…å®¹
                        // è¿™å°†è§¦å‘ change äº‹ä»¶ï¼Œä»è€Œé‡æ–°æ¸²æŸ“
                        editor.setValue(fixedCode);
                        
                        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
                        const toast = document.createElement('div');
                        toast.style.position = 'fixed';
                        toast.style.top = '20px';
                        toast.style.left = '50%';
                        toast.style.transform = 'translateX(-50%)';
                        toast.style.background = '#2ecc71';
                        toast.style.color = 'white';
                        toast.style.padding = '10px 20px';
                        toast.style.borderRadius = '5px';
                        toast.style.zIndex = '10000';
                        toast.style.boxShadow = '0 2px 10px rgba(0,0,0,0.2)';
                        toast.textContent = 'å·²è‡ªåŠ¨ä¿®å¤ä¸­æ–‡æ ‡ç‚¹ç¬¦å·';
                        document.body.appendChild(toast);
                        
                        setTimeout(() => {
                            toast.style.opacity = '0';
                            toast.style.transition = 'opacity 0.5s';
                            setTimeout(() => document.body.removeChild(toast), 500);
                        }, 2000);
                        
                        return;
                    } catch (e) {
                        console.log('Auto-fix attempt failed:', e);
                    }
                }
                
                // æ™ºèƒ½é”™è¯¯åˆ†æ
                const errorAnalysis = analyzeError(error.message, code);
                
                outputDiv.innerHTML = `<div class="error-message">
                    <strong>æ¸²æŸ“é”™è¯¯:</strong><br>
                    ${errorAnalysis.message}
                    ${errorAnalysis.suggestion ? `<br><br><strong>ğŸ’¡ å»ºè®®:</strong><br>${errorAnalysis.suggestion}` : ''}
                    <br><br>
                    <small style="color: #666">åŸå§‹é”™è¯¯: ${error.message}</small>
                </div>`;
            }
        }

        // é”™è¯¯åˆ†æå‡½æ•°
        function analyzeError(errorMessage, code) {
            let analysis = {
                message: 'æ— æ³•è§£æ Mermaid è¯­æ³•ï¼Œè¯·æ£€æŸ¥ä»£ç æ ¼å¼ã€‚',
                suggestion: ''
            };

            // 1. æ£€æŸ¥æ˜¯å¦æœ‰ä¸­æ–‡æ ‡ç‚¹ç¬¦å·
            const chinesePunctuation = /[ï¼ˆï¼‰ï¼šï¼›â€œâ€â€˜â€™ï¼Œã€‚]/;
            if (chinesePunctuation.test(code)) {
                analysis.suggestion += 'æ£€æµ‹åˆ°ä»£ç ä¸­åŒ…å«ä¸­æ–‡æ ‡ç‚¹ç¬¦å·ï¼ˆå¦‚ ï¼šï¼›ï¼ˆï¼‰ï¼‰ï¼ŒMermaid è¯­æ³•é€šå¸¸è¦æ±‚ä½¿ç”¨è‹±æ–‡æ ‡ç‚¹ç¬¦å·ã€‚è¯·å°è¯•å°†ä¸­æ–‡æ ‡ç‚¹æ›¿æ¢ä¸ºè‹±æ–‡æ ‡ç‚¹ã€‚<br>';
            }

            // 2. æ£€æŸ¥ Parse error
            if (errorMessage.includes('Parse error')) {
                // å°è¯•æå–è¡Œå·
                const lineMatch = errorMessage.match(/line\s+(\d+)/i);
                if (lineMatch) {
                    analysis.message = `ç¬¬ ${lineMatch[1]} è¡Œå­˜åœ¨è¯­æ³•é”™è¯¯ã€‚`;
                }
                
                // æ£€æŸ¥å¸¸è§é”™è¯¯æ¨¡å¼
                if (errorMessage.includes('Expecting')) {
                     analysis.suggestion += 'ä»£ç ç»“æ„å¯èƒ½ä¸ç¬¦åˆè§„èŒƒï¼Œæˆ–è€…ä½¿ç”¨äº†ä¸æ”¯æŒçš„å­—ç¬¦ã€‚å¦‚æœèŠ‚ç‚¹åç§°åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼ˆå¦‚ç©ºæ ¼ã€æ‹¬å·ã€å†’å·ç­‰ï¼‰ï¼Œè¯·å°è¯•ç”¨åŒå¼•å·åŒ…è£¹ï¼Œä¾‹å¦‚: id["èŠ‚ç‚¹å†…å®¹"]ã€‚<br>';
                }
            }

            // 3. æ£€æŸ¥ç‰¹å®šå…³é”®è¯æ··æ·†
            if (code.includes('-->') && code.includes('graph') && errorMessage.includes('got')) {
                 // å¯èƒ½æ˜¯ç®­å¤´æ ¼å¼ä¸å¯¹ï¼Œæˆ–è€…èŠ‚ç‚¹åé—®é¢˜
            }

            if (!analysis.suggestion) {
                analysis.suggestion = 'è¯·æ£€æŸ¥ Mermaid è¯­æ³•æ˜¯å¦æ­£ç¡®ï¼Œæˆ–è€…å°è¯•ç®€åŒ–å›¾è¡¨é€æ­¥æ’æŸ¥é—®é¢˜ã€‚';
            }

            return analysis;
        }

        // ç¼©æ”¾åŠŸèƒ½
        function zoomIn() {
            currentZoom = Math.min(currentZoom * 1.2, 3);
            applyZoom();
        }

        function zoomOut() {
            currentZoom = Math.max(currentZoom / 1.2, 0.1);
            applyZoom();
        }

        function resetZoom() {
            currentZoom = 1;
            applyZoom();
            centerDiagram();
        }

        function fitToScreen() {
            const viewport = document.getElementById('diagram-viewport');
            const container = document.getElementById('diagram-container');
            const output = document.getElementById('mermaid-output');
            
            if (!output.firstElementChild) return;
            
            const viewportRect = viewport.getBoundingClientRect();
            const outputRect = output.getBoundingClientRect();
            
            const scaleX = (viewportRect.width - 40) / outputRect.width;
            const scaleY = (viewportRect.height - 40) / outputRect.height;
            
            currentZoom = Math.min(scaleX, scaleY, 1);
            applyZoom();
            centerDiagram();
        }

        function applyZoom() {
            const container = document.getElementById('diagram-container');
            container.style.transform = `scale(${currentZoom})`;
            
            const zoomLevel = document.getElementById('zoom-level');
            zoomLevel.textContent = Math.round(currentZoom * 100) + '%';
        }

        function centerDiagram() {
            const viewport = document.getElementById('diagram-viewport');
            const container = document.getElementById('diagram-container');
            
            // ç­‰å¾…å˜æ¢å®Œæˆåå±…ä¸­
            setTimeout(() => {
                const viewportRect = viewport.getBoundingClientRect();
                const containerRect = container.getBoundingClientRect();
                
                const centerX = (viewportRect.width - containerRect.width) / 2;
                const centerY = (viewportRect.height - containerRect.height) / 2;
                
                viewport.scrollLeft = -centerX;
                viewport.scrollTop = -centerY;
            }, 100);
        }

        // æ‹–æ‹½åŠŸèƒ½
        function initDragAndDrop() {
            const viewport = document.getElementById('diagram-viewport');
            
            viewport.addEventListener('mousedown', (e) => {
                isDragging = true;
                dragStart.x = e.clientX;
                dragStart.y = e.clientY;
                scrollStart.x = viewport.scrollLeft;
                scrollStart.y = viewport.scrollTop;
                viewport.style.cursor = 'grabbing';
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                e.preventDefault();
                const deltaX = e.clientX - dragStart.x;
                const deltaY = e.clientY - dragStart.y;
                
                viewport.scrollLeft = scrollStart.x - deltaX;
                viewport.scrollTop = scrollStart.y - deltaY;
            });

            document.addEventListener('mouseup', () => {
                isDragging = false;
                viewport.style.cursor = 'grab';
            });

            // é¼ æ ‡æ»šè½®ç¼©æ”¾
            viewport.addEventListener('wheel', (e) => {
                e.preventDefault();
                
                if (e.deltaY < 0) {
                    zoomIn();
                } else {
                    zoomOut();
                }
            });
        }

        // å…¨å±åŠŸèƒ½
        function toggleFullscreen() {
            const overlay = document.getElementById('fullscreen-overlay');
            const output = document.getElementById('mermaid-output');
            const fullscreenDiagram = document.getElementById('fullscreen-diagram');
            
            if (!isFullscreen) {
                // è¿›å…¥å…¨å±
                if (output.innerHTML.trim()) {
                    fullscreenDiagram.innerHTML = output.innerHTML;
                    overlay.classList.add('active');
                    isFullscreen = true;
                    fullscreenZoom = 1;
                    updateFullscreenZoom();
                    initFullscreenDragAndDrop();
                    
                    // é˜»æ­¢é¡µé¢æ»šåŠ¨
                    document.body.style.overflow = 'hidden';
                }
            } else {
                // é€€å‡ºå…¨å±
                exitFullscreen();
            }
        }

        function exitFullscreen() {
            const overlay = document.getElementById('fullscreen-overlay');
            overlay.classList.remove('active');
            isFullscreen = false;
            
            // æ¢å¤é¡µé¢æ»šåŠ¨
            document.body.style.overflow = 'auto';
        }

        // å…¨å±æ¨¡å¼ä¸‹çš„ç¼©æ”¾åŠŸèƒ½
        function fullscreenZoomIn() {
            fullscreenZoom = Math.min(fullscreenZoom * 1.2, 5);
            updateFullscreenZoom();
        }

        function fullscreenZoomOut() {
            fullscreenZoom = Math.max(fullscreenZoom / 1.2, 0.1);
            updateFullscreenZoom();
        }

        function fullscreenZoomReset() {
            fullscreenZoom = 1;
            updateFullscreenZoom();
            centerFullscreenDiagram();
        }

        function fullscreenZoomFit() {
            const viewport = document.getElementById('fullscreen-viewport');
            const diagram = document.getElementById('fullscreen-diagram');
            
            if (!diagram.firstElementChild) return;
            
            const viewportRect = viewport.getBoundingClientRect();
            const diagramRect = diagram.firstElementChild.getBoundingClientRect();
            
            const scaleX = (viewportRect.width - 40) / diagramRect.width;
            const scaleY = (viewportRect.height - 40) / diagramRect.height;
            
            fullscreenZoom = Math.min(scaleX, scaleY, 1);
            updateFullscreenZoom();
            centerFullscreenDiagram();
        }

        function updateFullscreenZoom() {
            const diagram = document.getElementById('fullscreen-diagram');
            diagram.style.transform = `scale(${fullscreenZoom})`;
            
            const zoomLevel = document.getElementById('fullscreen-zoom-level');
            zoomLevel.textContent = Math.round(fullscreenZoom * 100) + '%';
        }

        function centerFullscreenDiagram() {
            const viewport = document.getElementById('fullscreen-viewport');
            const diagram = document.getElementById('fullscreen-diagram');
            
            setTimeout(() => {
                const viewportRect = viewport.getBoundingClientRect();
                const diagramRect = diagram.getBoundingClientRect();
                
                const centerX = (viewportRect.width - diagramRect.width) / 2;
                const centerY = (viewportRect.height - diagramRect.height) / 2;
                
                viewport.scrollLeft = -centerX;
                viewport.scrollTop = -centerY;
            }, 100);
        }

        // å…¨å±æ¨¡å¼ä¸‹çš„æ‹–æ‹½åŠŸèƒ½
        function initFullscreenDragAndDrop() {
            const viewport = document.getElementById('fullscreen-viewport');
            let fullscreenDragging = false;
            let fullscreenDragStart = { x: 0, y: 0 };
            let fullscreenScrollStart = { x: 0, y: 0 };
            
            const mouseDownHandler = (e) => {
                fullscreenDragging = true;
                fullscreenDragStart.x = e.clientX;
                fullscreenDragStart.y = e.clientY;
                fullscreenScrollStart.x = viewport.scrollLeft;
                fullscreenScrollStart.y = viewport.scrollTop;
                viewport.style.cursor = 'grabbing';
            };

            const mouseMoveHandler = (e) => {
                if (!fullscreenDragging) return;
                
                e.preventDefault();
                const deltaX = e.clientX - fullscreenDragStart.x;
                const deltaY = e.clientY - fullscreenDragStart.y;
                
                viewport.scrollLeft = fullscreenScrollStart.x - deltaX;
                viewport.scrollTop = fullscreenScrollStart.y - deltaY;
            };

            const mouseUpHandler = () => {
                fullscreenDragging = false;
                viewport.style.cursor = 'grab';
            };

            const wheelHandler = (e) => {
                e.preventDefault();
                
                if (e.deltaY < 0) {
                    fullscreenZoomIn();
                } else {
                    fullscreenZoomOut();
                }
            };

            // ç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            viewport.removeEventListener('mousedown', mouseDownHandler);
            document.removeEventListener('mousemove', mouseMoveHandler);
            document.removeEventListener('mouseup', mouseUpHandler);
            viewport.removeEventListener('wheel', wheelHandler);

            // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
            viewport.addEventListener('mousedown', mouseDownHandler);
            document.addEventListener('mousemove', mouseMoveHandler);
            document.addEventListener('mouseup', mouseUpHandler);
            viewport.addEventListener('wheel', wheelHandler);
        }

        // ç›‘å¬ç¼–è¾‘å™¨å˜åŒ–
        editor.on('change', function() {
            clearTimeout(renderTimeout);
            renderTimeout = setTimeout(renderMermaid, 500);
        });

        // ç¤ºä¾‹ä»£ç 
        const examples = {
            flowchart: `graph TD
    A[å¼€å§‹] --> B{æ˜¯å¦æ»¡è¶³æ¡ä»¶?}
    B -->|æ˜¯| C[æ‰§è¡Œæ“ä½œ]
    B -->|å¦| D[è·³è¿‡æ“ä½œ]
    C --> E[ç»“æŸ]
    D --> E
    
    style A fill:#e1f5fe
    style E fill:#c8e6c9
    style B fill:#fff3e0`,
            
            sequence: `sequenceDiagram
    participant A as ç”¨æˆ·
    participant B as ç³»ç»Ÿ
    participant C as æ•°æ®åº“
    
    A->>B: ç™»å½•è¯·æ±‚
    B->>C: éªŒè¯ç”¨æˆ·ä¿¡æ¯
    C-->>B: è¿”å›éªŒè¯ç»“æœ
    B-->>A: ç™»å½•æˆåŠŸ/å¤±è´¥`,
            
            gantt: `gantt
    title é¡¹ç›®å¼€å‘è®¡åˆ’
    dateFormat  YYYY-MM-DD
    section è®¾è®¡é˜¶æ®µ
    éœ€æ±‚åˆ†æ      :done,    des1, 2024-01-01,2024-01-05
    UIè®¾è®¡        :active,  des2, 2024-01-06, 3d
    section å¼€å‘é˜¶æ®µ
    å‰ç«¯å¼€å‘      :         dev1, after des2, 5d
    åç«¯å¼€å‘      :         dev2, after des2, 5d
    æµ‹è¯•         :         test1, after dev1, 2d`,
            
            class: `classDiagram
    class Animal {
        +String name
        +int age
        +makeSound()
        +move()
    }
    class Dog {
        +String breed
        +bark()
        +wagTail()
    }
    class Cat {
        +String color
        +meow()
        +purr()
    }
    Animal <|-- Dog
    Animal <|-- Cat`,
            
            state: `stateDiagram-v2
    [*] --> å¾…æœº
    å¾…æœº --> è¿è¡Œ : å¯åŠ¨
    è¿è¡Œ --> æš‚åœ : æš‚åœ
    æš‚åœ --> è¿è¡Œ : ç»§ç»­
    è¿è¡Œ --> åœæ­¢ : åœæ­¢
    æš‚åœ --> åœæ­¢ : åœæ­¢
    åœæ­¢ --> [*]`,
            
            pie: `pie title ç¼–ç¨‹è¯­è¨€ä½¿ç”¨å æ¯”
    "JavaScript" : 35
    "Python" : 25
    "Java" : 20
    "C++" : 10
    "å…¶ä»–" : 10`
        };

        // åŠ è½½ç¤ºä¾‹
        function loadExample(type) {
            if (type && examples[type]) {
                editor.setValue(examples[type]);
                renderMermaid();
            }
        }

        // å¯¼å‡ºåŠŸèƒ½
        function exportSVG() {
            const svg = document.querySelector('#mermaid-output svg');
            if (svg) {
                const svgData = new XMLSerializer().serializeToString(svg);
                const blob = new Blob([svgData], { type: 'image/svg+xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'mermaid-diagram.svg';
                a.click();
                URL.revokeObjectURL(url);
            } else {
                alert('è¯·å…ˆç”Ÿæˆå›¾è¡¨å†å¯¼å‡º');
            }
        }

        function exportPNG() {
            console.log('å¼€å§‹å¯¼å‡º PNG...');
            const svg = document.querySelector('#mermaid-output svg');
            if (!svg) {
                alert('è¯·å…ˆç”Ÿæˆå›¾è¡¨å†å¯¼å‡º');
                return;
            }

            // 1. å‡†å¤‡æ•°æ®å’Œå°ºå¯¸
            // Clone the SVG node
            const clonedSvg = svg.cloneNode(true);
            
            // Get the size
            let width, height;
            if (svg.viewBox && svg.viewBox.baseVal && svg.viewBox.baseVal.width > 0) {
                width = svg.viewBox.baseVal.width;
                height = svg.viewBox.baseVal.height;
            } else {
                const rect = svg.getBoundingClientRect();
                width = rect.width / currentZoom;
                height = rect.height / currentZoom;
            }
            
            // Padding & Scale
            const padding = 20;
            const scale = 2;
            const exportWidth = width * scale;
            const exportHeight = height * scale;
            
            // Update cloned SVG attributes
            if (!clonedSvg.hasAttribute('viewBox')) {
                clonedSvg.setAttribute('viewBox', `0 0 ${width} ${height}`);
            }
            if (!clonedSvg.hasAttribute('xmlns')) {
                clonedSvg.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
            }
            clonedSvg.setAttribute('width', exportWidth);
            clonedSvg.setAttribute('height', exportHeight);
            clonedSvg.style.maxWidth = 'none';

            // 2. å®šä¹‰ä¸‹è½½å‡½æ•°
            const downloadBlob = (blob) => {
                const downloadUrl = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = 'mermaid-diagram.png';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(downloadUrl);
                console.log('ä¸‹è½½å·²è§¦å‘');
            };

            // 3. å®šä¹‰ Canvg å¤‡ç”¨æ–¹æ¡ˆ (ç”¨äºå¤„ç†è·¨åŸŸæˆ– file:// åè®®é—®é¢˜)
            const useCanvg = () => {
                console.log('å°è¯•ä½¿ç”¨ Canvg å¯¼å‡º...');
                try {
                    if (typeof canvg === 'undefined') {
                        throw new Error('Canvg åº“æœªåŠ è½½');
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = exportWidth + (padding * 2 * scale);
                    canvas.height = exportHeight + (padding * 2 * scale);
                    const ctx = canvas.getContext('2d');
                    
                    // ç™½è‰²èƒŒæ™¯
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    const svgData = new XMLSerializer().serializeToString(clonedSvg);
                    
                    // ä½¿ç”¨ canvg æ¸²æŸ“
                    canvg(canvas, svgData, {
                        ignoreMouse: true,
                        ignoreAnimation: true,
                        scaleWidth: exportWidth,
                        scaleHeight: exportHeight,
                        offsetX: padding * scale,
                        offsetY: padding * scale,
                        useCORS: true,
                        log: true
                    });
                    
                    // Canvg é€šå¸¸æ˜¯åŒæ­¥æ¸²æŸ“çš„
                    canvas.toBlob((blob) => {
                        if (blob) {
                            downloadBlob(blob);
                        } else {
                            alert('Canvg å¯¼å‡ºå¤±è´¥ï¼šæ— æ³•ç”Ÿæˆå›¾ç‰‡æ•°æ®');
                        }
                    }, 'image/png');
                } catch (e) {
                    console.error('Canvg å¯¼å‡ºå‡ºé”™:', e);
                    alert('å¯¼å‡ºå¤±è´¥ã€‚å¦‚æœæ‚¨æ˜¯åœ¨æœ¬åœ°ç›´æ¥æ‰“å¼€æ–‡ä»¶ï¼Œå»ºè®®å°è¯•å¯åŠ¨ä¸€ä¸ªæœ¬åœ° Web æœåŠ¡å™¨æ¥è¿è¡Œæ­¤å·¥å…·ï¼Œæˆ–è€…ç›´æ¥ä½¿ç”¨â€œå¯¼å‡º SVGâ€åŠŸèƒ½ã€‚');
                }
            };

            // 4. å°è¯•åŸç”Ÿæ–¹æ¡ˆ
            try {
                const canvas = document.createElement('canvas');
                canvas.width = exportWidth + (padding * 2 * scale);
                canvas.height = exportHeight + (padding * 2 * scale);
                const ctx = canvas.getContext('2d');
                
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                const svgData = new XMLSerializer().serializeToString(clonedSvg);
                // ä½¿ç”¨ base64 
                const base64Data = btoa(unescape(encodeURIComponent(svgData)));
                const imgSrc = 'data:image/svg+xml;base64,' + base64Data;
                
                img.onload = function() {
                    try {
                        ctx.fillStyle = 'white';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, padding * scale, padding * scale, exportWidth, exportHeight);
                        
                        // å°è¯•ç”Ÿæˆ Blob
                        canvas.toBlob(function(blob) {
                            if (blob) {
                                downloadBlob(blob);
                            } else {
                                console.warn('åŸç”Ÿ toBlob è¿”å› nullï¼Œåˆ‡æ¢åˆ° Canvg');
                                useCanvg();
                            }
                        }, 'image/png');
                    } catch (e) {
                        console.warn('åŸç”Ÿ Canvas ç»˜å›¾/å¯¼å‡ºå¤±è´¥ (SecurityError?), åˆ‡æ¢åˆ° Canvg', e);
                        useCanvg();
                    }
                };
                
                img.onerror = function(e) {
                    console.warn('åŸç”Ÿå›¾ç‰‡åŠ è½½å¤±è´¥, åˆ‡æ¢åˆ° Canvg', e);
                    useCanvg();
                };
                
                img.src = imgSrc;
                
            } catch (e) {
                console.warn('åŸç”Ÿæ–¹æ¡ˆåˆå§‹åŒ–å¤±è´¥, åˆ‡æ¢åˆ° Canvg', e);
                useCanvg();
            }
        }

        function clearEditor() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºç¼–è¾‘å™¨å†…å®¹å—ï¼Ÿ')) {
                editor.setValue('');
                document.getElementById('mermaid-output').innerHTML = '<div class="loading">è¯·è¾“å…¥ Mermaid ä»£ç ...</div>';
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
            initDragAndDrop();
            
            // ç»‘å®šç¼©æ”¾æŒ‰é’®äº‹ä»¶
            document.getElementById('zoom-in').addEventListener('click', zoomIn);
            document.getElementById('zoom-out').addEventListener('click', zoomOut);
            document.getElementById('zoom-reset').addEventListener('click', resetZoom);
            document.getElementById('zoom-fit').addEventListener('click', fitToScreen);
            
            // ç»‘å®šå…¨å±æŒ‰é’®äº‹ä»¶
            document.getElementById('fullscreen-btn').addEventListener('click', toggleFullscreen);
            
            // ç»‘å®šå…¨å±æ¨¡å¼ä¸‹çš„æ§åˆ¶æŒ‰é’®
            document.getElementById('fullscreen-zoom-in').addEventListener('click', fullscreenZoomIn);
            document.getElementById('fullscreen-zoom-out').addEventListener('click', fullscreenZoomOut);
            document.getElementById('fullscreen-zoom-reset').addEventListener('click', fullscreenZoomReset);
            document.getElementById('fullscreen-zoom-fit').addEventListener('click', fullscreenZoomFit);
            document.getElementById('fullscreen-close').addEventListener('click', exitFullscreen);
            
            // ESCé”®é€€å‡ºå…¨å±
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && isFullscreen) {
                    exitFullscreen();
                }
            });
            
            // ç‚¹å‡»è¦†ç›–å±‚èƒŒæ™¯é€€å‡ºå…¨å±
            document.getElementById('fullscreen-overlay').addEventListener('click', function(e) {
                if (e.target === this) {
                    exitFullscreen();
                }
            });
            
            // æ¸²æŸ“é»˜è®¤ç¤ºä¾‹
            renderMermaid();
        });
    </script>
</body>
</html>